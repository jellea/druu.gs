var App=function(b){b.App.init({name:"erowid",version:"1.1"});return{}}(LUNGO);
App.Data=function(b){b.Data.Sql.init({name:"druu.gs",version:"1.0",schema:[{name:"substances",drop:!1,fields:{id:"INTEGER PRIMARY KEY",name:"TEXT",info:"TEXT",exp:"TEXT",perma:"TEXT",totalexp:"INTEGER",basics:"TEXT",chemistry:"TEXT",dose:"TEXT",effects:"TEXT",images:"TEXT",law:"TEXT"}},{name:"experiences",drop:!1,fields:{id:"INTEGER PRIMARY KEY",fav:"INTEGER DEFAULT 0",title:"TEXT",author:"TEXT",content:"",date:"TEXT",url:"TEXT",subs:"TEXT",subid:"INTEGER"}}]});var a=function(a,g){var d=[];b.Data.Sql.execute(a,
function(b){for(var a=0,c=b.rows.length;a<c;a++)d.push(b.rows.item(a));g(d)})},h=function(c){a('SELECT * FROM experiences WHERE id = "'+c+'"',function(g){null==g[0].content?(LUNGO.Sugar.Growl.show("Loading!","Downloading Experience","loading"),g={q:"select * from html where url='            http://www.erowid.org/experiences/exp.php?ID="+encodeURIComponent(c)+"'            and xpath='//div[@class=\"report-text-surround\"]/p' and charset='iso-8859-1'",format:"json"},b.Service.cache("http://query.yahooapis.com/v1/public/yql",
g,"10 minutes",function(b){a('UPDATE experiences SET content="'+b.query.results.p.content.replace(/\n/g,"<br>")+'" WHERE id='+c+";",function(){});LUNGO.Sugar.Growl.hide();h(c)})):App.View.makeExperiencePage(g)})},d=function(){a("SELECT * FROM substances ORDER BY totalexp DESC LIMIT 10",function(b){var a=[];for(i in b)a.push(b[i]);App.View.makeTop10List(a)})},e=function(){a("SELECT * FROM substances ORDER BY name ASC",function(c){0==c.length?b.Service.get("data/substances-list2.json","10 days",function(a){for(item in a)delete a[item].deepinfo,
""==a[item].info&&delete a[item].info,a[item].id=item;b.Data.Sql.insert("substances",a);e()}):(App.View.makeAsideSubstanceList(c),a("SELECT * FROM experiences WHERE fav = 1",function(b){var a=[];0==b.length&&a.push({title:"No favorite experiences yet! Click the star to                        add a favorite",id:"NoGo"});for(i in b)a.push(b[i]);App.View.makeFavoritesList(a)}),d())})};e();return{getExperiencesList:function(c){LUNGO.Sugar.Growl.show("Loading!","Downloading Info and Experiences","loading");
a('SELECT * FROM experiences WHERE subid="'+c[0].id+'" LIMIT 100',function(a){0==a.length?(console.log(c[0]),a={q:"select * from html where url='"+encodeURIComponent(c[0].exp)+"' and xpath='//center/table/tr/td/form/table/tr[position()>2]'",format:"json"},b.Service.cache("http://query.yahooapis.com/v1/public/yql",a,"10 days",function(a){rowdata=[];"Object"==App.Data.type(a.query.results.tr)&&(a.query.results.tr=[a.query.results.tr]);for(item in a.query.results.tr){var d=a.query.results.tr[item],f=
{};f.id=d.td[1].a.href.replace("exp.php?ID=","");f.author=d.td[2].p;f.title=d.td[1].a.content;f.subs=d.td[3].p;f.date=d.td[4].p;f.url=d.td[1].a.href;f.fav=0;f.subid=c[0].id;rowdata.push(f)}b.Data.Sql.insert("experiences",rowdata);App.View.makeExperiencesList(rowdata)})):App.View.makeExperiencesList(a)})},type:function(a){return!!a&&Object.prototype.toString.call(a).match(/(\w+)\]/)[1]},getExperience:h,getInfolinks:function(a){for(infotype in a.deepinfo)console.log(a.deepinfo[infotype]);return a},
searchSubstance:function(b){a('SELECT * FROM substances WHERE name LIKE "%'+b+'%" ORDER BY name ASC',function(a){App.View.makeAsideSubstanceList(a)})},getNextExperience:function(b,d,e){if("prev"==e)var e="<",j="ORDER BY id DESC";else e=">",j="";a("SELECT id FROM experiences WHERE id "+e+' "'+b+'" AND subid='+d+" "+j+" LIMIT 1",function(a){null!=a[0]&&h(a[0].id)})},setFav:function(){a('UPDATE experiences SET fav="1"                  WHERE id='+$(".reporttext").attr("id")+";",function(){})},makeTop10List:d}}(LUNGO,
App);
App.Events=function(b){function a(a){App.Data.getNextExperience($(".reporttext").attr("id"),$(".reporttext").attr("subid"),a)}b.ready(function(){b.View.Aside.show("#welcome","#substances-aside")});var h=function(a){b.Data.Sql.select("substances",{id:a},function(e){null!=e&&(_gaq.push(["_trackPageview","/#/substance-"+e.name+""]),b.dom("#welcome header .title").text(e.name),b.dom('a[id="'+a+'"] span.bubble.count').text(e.totalexp),b.dom(".aside-item").removeClass("current"),b.dom('a[id="'+a+'"]').addClass("current"),App.Data.getExperiencesList(e),
App.Data.getInfolinks(e))})};b.dom('a[href="#details-experiences"]').tap(function(a){$('input[type="search"]').blur();h(a.currentTarget.id)});b.dom('a[href="#report"]').tap(function(a){"NoGo"!=a.currentTarget.id&&(App.Data.getExperience(a.currentTarget.id),_gaq.push(["_trackPageview","/#/experience-"+a.currentTarget.id+""]))});b.dom(".search-icon").tap(function(){b.dom(".aside-search").show();$('input[type="search"]').focus()});$('input[type="search"]').keyup(function(a){App.Data.searchSubstance(a.target.value)});
$('input[type="search"]').blur(function(){""==$('input[type="search"]').val()&&setTimeout(function(){App.Data.searchSubstance("");b.dom(".aside-search").hide()},800)});$("input + a").click(function(){App.Data.searchSubstance("");b.dom(".aside-search").hide()});b.dom(".reporttext").swipeRight(function(){a("prev")});b.dom(".reportarrowleft").tap(function(){a("prev")});b.dom(".reporttext").swipeLeft(function(){a("next")});b.dom(".reportarrowright").tap(function(){a("next")});$(document).keyup(function(b){37==
b.which?a("prev"):35==b.which&&a("next")});$("nav .icon.star").click(function(){App.Data.setFav();$("nav .icon.star").css("color","#fff")});b.View.Aside.show("#welcome","#substances-aside");return{goToSubtance:h}}(LUNGO,App);App.Services=function(){return{}}(LUNGO,App);
App.View=function(b){b.View.Template.create("favorites-tmp",'<li class="selectable">                           <a id="{{id}}" href="#report"                           data-target="section">{{title}}</a></li>');b.View.Template.create("top10-tmp",'<li class="selectable">                           <a id="{{id}}" href="#details-experiences"                           data-target="article">                           <span class="bubble count">{{totalexp}}</span>                           {{name}}</a>                           </li>');
b.View.Template.create("substances-aside-tmp",'<a id="{{id}}"                           href="#details-experiences" class="{{id}} aside-item"                           data-count="{{totalexp}}" data-target="article">                           {{name}}</a>');b.View.Template.create("experiencelist-tmp",'<li class="selectable">                           <a href="#report" id="{{id}}" data-target="section">                           <div class="onright">{{subs}}</div>                           {{title}}                           <small>{{author}} {{date}}</small></a>                           </li>  ');
b.View.Template.create("reportpage-tmp","{{content}}");return{makeExperiencesList:function(a){b.View.Template.render("#details-experiences ul","experiencelist-tmp",a);b.View.Scroll.refresh("details-experiences");LUNGO.Sugar.Growl.hide()},makeFavoritesList:function(a){b.View.Template.render("#favlist","favorites-tmp",a);b.View.Scroll.refresh("start")},makeAsideSubstanceList:function(a){b.View.Template.render("#substances-aside .aside-items","substances-aside-tmp",a);b.View.Scroll.refresh("substances-aside");
for(item in a)b.View.Element.count('#substances-aside a[id="'+a[item].id+'"]',a[item].totalexp)},makeExperiencePage:function(a){b.View.Template.render(".reporttext","reportpage-tmp",a);b.dom("#report header .title").text(a[0].title);b.dom(".reporttext").attr("id",a[0].id);b.dom(".reporttext").attr("subid",a[0].subid);1==a[0].fav?$("nav .icon.star").css("color","#fff"):$("nav .icon.star").css("color","inherit");b.View.Scroll.refresh("reportpage");b.View.Scroll.first("details-experiences");$(".reporttext").css("-webkit-transform",
"translate3d(0px, 0px, 0px) scale(1)")},scrollUp:function(){b.View.Scroll.first("#details-experiences")},makeTop10List:function(a){b.View.Template.render("#top10list","top10-tmp",a);b.View.Scroll.refresh("start")}}}(LUNGO,App);
